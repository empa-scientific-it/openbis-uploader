version: "3.9"
volumes:
  #These correspond to the N: folders where
  #the user can place the data to upload
  dropboxes:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/basi/dropboxes
  # openbis-state:
  #   driver: local
  #   driver_opts:
  #     o: bind
  #     type: none
  #     device: /home/basi/openbis-state
services:
  data-discovery:
    build: 
      context: ./services/
      dockerfile: ./data-discovery/Dockerfile
    volumes:
      - ./services/data-discovery/app:/app/
      -  dropboxes:/shares/
      - ./services/openbis-configuration/instance_creator:/instance_creator/
    hostname: data-discovery
    ports:
      - "8080:80"
    depends_on:
      - openbis
      - ldap
    environment:
      - BASE_PATH=/shares
      - LDAP_SERVER=ldap
      - LDAP_PORT=1389
      - LDAP_PRINCIPAL_NAME=cn=admin,dc=empa,dc=ch
      - LDAP_PRINCIPAL_PASSWORD=password
      - LDAP_BASE=dc=empa,dc=ch
      - OPENBIS_SERVER=https://openbis:443
      - JWS_SECRET_KEY=72f0337b7a0ba5efc612af93bd75e5ff305e329acee0cfa57bd15b843b5789f3
      - CREDENTIALS_STORAGE_KEY=428c9416c004ea21fcfe3480d3b84d92306784bea452d3a249cdcf9e6250eeb8
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
  cache:
    image: redis:6.2-alpine
    restart: always
    ports:
      - '6379:6379'
    command: redis-server --save 20 1 --loglevel warning --requirepass eYVX7EwVmmxKPCDmwMtyKVge8oLd2t81
    volumes: 
      - ./builds/cache:/data
    hostname: redis
    
  ldap:
    image: bitnami/openldap:latest
    environment:
      - BITNAMI_DEBUG=true
      - LDAP_ROOT=dc=empa,dc=ch
      - LDAP_ADMIN_USERNAME=admin 
      - LDAP_ADMIN_PASSWORD=password 
      - LDAP_EXTRA_SCHEMAS=cosine,inetorgperson,nis,memberof
    volumes:
        - './services/ldap/memberof.ldif:/opt/bitnami/openldap/etc/schema/memberof.ldif'
        - ./services/ldap/test_users.ldif:/ldifs/test_users.ldif
    hostname: ldap
    ports:
      - "1389:1389"
      - "1636:1636"

  
  openbis:
    build: ./services/openbis
    #image: openbis/debian-openbis:latest
    environment:
      - SERVER_HOST_PORT=localhost:8443
      - CORE_PLUGINS=enabled-modules = dataset-uploader, dataset-file-search, xls-import, eln-lims, openbis-ng-ui, search-store, user-management-maintenance
    volumes:
      - ./services/openbis/service.properties:/home/openbis/openbis_state/as_etc/service.properties
      #- ./services/openbis/dss_service.properties:/home/openbis/openbis_state/dss_etc/service.properties
      - ./services/openbis/groups.json:/home/openbis/openbis_state/as_etc/groups.json
      #- dropboxes:/home/openbis/openbis_state/dss_store/eln-lims-dropbox-marker/
      - ./builds/openbis/:/home/openbis/openbis_state/

    ports:
      - "8443:443"
    hostname: openbis
    depends_on:
      - ldap
    healthcheck:
      test: ["CMD", "curl", "openbis:443"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

  openbis-initialiser:
    build: 
      context: ./services/
      dockerfile: ./openbis-initialiser/Dockerfile
    depends_on:
      openbis:
        condition: service_healthy
    environment:
      - OPENBIS_URL=openbis
      - OPENBIS_PORT=443
      - OPENBIS_ADMIN_USER=admin
      - OPENBIS_ADMIN_PASSWORD=changeit
  frontend:
    build: 
      context: ./apps/front
      target: "build-stage"
    volumes:
      - ./apps/front/app:/usr/app/
    command: sh -c "npm run dev"
    ports:
      - "8000:5173"
    depends_on:
      - data-discovery